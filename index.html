<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>3D Model</title>
    <link rel="icon" href="./favicon.svg" type="image/svg+xml" />
    <script type="module"
      src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js">
    </script>
    <script nomodule
      src="https://unpkg.com/@google/model-viewer/dist/model-viewer-legacy.js">
    </script>
    <style>
      html, body { height: 100%; margin: 0; background: #111; }
      model-viewer { width: 100%; height: 100%; }
      .top-left {
        position: fixed;
        top: 16px;
        left: 16px;
        z-index: 12;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .scene-title {
        padding: 8px 10px;
        border-radius: 10px;
        background: rgba(0,0,0,0.55);
        color: #fff;
        border: 1px solid rgba(255,255,255,0.15);
        box-shadow: 0 6px 24px rgba(0,0,0,0.35);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        font-size: 13px;
        line-height: 1.1;
        user-select: none;
      }
      .info-panel {
        position: fixed;
        top: 60px;
        left: 16px;
        z-index: 11;
        width: min(620px, calc(100vw - 32px));
        max-height: calc(100vh - 32px);
        overflow: auto;
        padding: 14px 16px;
        border-radius: 12px;
        background: rgba(0,0,0,0.55);
        color: #eaeaea;
        box-shadow: 0 6px 24px rgba(0,0,0,0.35);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
      }
      .info-panel h1 {
        margin: 0 0 8px 0;
        font-size: 18px;
        line-height: 1.3;
        color: #fff;
      }
      .info-panel p {
        margin: 0;
        font-size: 14px;
        line-height: 1.5;
        color: #dcdcdc;
      }
      .info-panel .img {
        width: 100%;
        height: auto;
        display: block;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.12);
        margin: 10px 0 12px 0;
        background: rgba(255,255,255,0.06);
      }
      .info-panel ol {
        margin: 10px 0 0 18px;
        padding: 0;
        color: #dcdcdc;
        font-size: 14px;
        line-height: 1.5;
      }
      .info-panel li { margin: 6px 0; }
      .help-panel {
        position: fixed;
        left: 16px;
        bottom: 16px;
        max-width: 460px;
        padding: 14px 16px;
        border-radius: 12px;
        background: rgba(0,0,0,0.55);
        color: #eaeaea;
        box-shadow: 0 6px 24px rgba(0,0,0,0.35);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
      }
      .help-panel .row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 6px 0;
        font-size: 13px;
      }
      .kbd {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 6px;
        border: 1px solid rgba(255,255,255,0.18);
        background: rgba(255,255,255,0.08);
        color: #fff;
        font-size: 12px;
      }
      .actions {
        margin-top: 10px;
        display: flex;
        gap: 8px;
      }
      .btn {
        cursor: pointer;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.15);
        background: rgba(255,255,255,0.1);
        color: #fff;
        font-size: 13px;
        transition: background 0.2s ease, transform 0.05s ease;
      }
      .btn:hover { background: rgba(255,255,255,0.18); }
      .btn:active { transform: translateY(1px); }
      .status-panel {
        position: fixed;
        top: 16px;
        right: 16px;
        max-width: 320px;
        padding: 10px 12px;
        border-radius: 10px;
        background: rgba(0,0,0,0.55);
        color: #eaeaea;
        box-shadow: 0 6px 24px rgba(0,0,0,0.35);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <div class="top-left">
      <div class="scene-title" aria-label="Scene title">Falciform Ligament Line (FLL)</div>
      <button id="info-toggle" class="btn" type="button" aria-controls="info-panel" aria-expanded="false">Info</button>
    </div>
    <div id="info-panel" class="info-panel" role="dialog" aria-label="FLL info" hidden>
      <h1>Falciform Ligament Line (FLL)</h1>
      <img id="info-image" class="img" src="./fll-labels.jpg" alt="FLL diagram with labels" loading="lazy" />
      <p id="info-image-fallback" hidden>
        (Add the diagram image as <strong>fll-labels.jpg</strong> next to this page to display it here.)
      </p>
      <p>
        If we draw a line tangential to falciform ligament at the transition of the intraorbital to intracranial optic nerve, this line will cross the following from medial to lateral:
      </p>
      <ol>
        <li>Distal dural ring (DDR)</li>
        <li>Ophthalmic artery (A) (distal to DDR)</li>
        <li>Posterior wall of clinoidal segment (Clin. Seg.) of ICA</li>
        <li>Proximal dural ring (PDR)</li>
        <li>The point where CN IV begins crossing over CN III at superior orbital fissure (SOF).</li>
        <li>FLL is just anterior to ILT and CN VI which can be located lateral to ILT;</li>
      </ol>
      <div class="actions">
        <button id="info-close" class="btn" type="button">Close</button>
      </div>
    </div>
    <model-viewer
      src="./vessel-4.glb?v=2026-02-15"
      camera-controls
      auto-rotate
      rotation-per-second="20deg"
      bounds="tight"
      loading="eager"
      poster="./poster.svg"
      environment-image="neutral"
      shadow-intensity="0.8"
      exposure="1.0"
      alt="3D model">
    </model-viewer>
    <div id="status" class="status-panel" role="status" aria-live="polite">Loading model…</div>
    <div class="help-panel" aria-live="polite" aria-label="Interaction help">
      <div class="row"><span class="kbd">Drag</span> Rotate the skull</div>
      <div class="row"><span class="kbd">Scroll / Pinch</span> Zoom in/out</div>
      <div class="row"><span class="kbd">Shift + Drag</span> Pan the view</div>
      <div class="row"><span class="kbd">Double‑click / Double‑tap</span> Focus on a point</div>
      <div class="actions">
        <button id="toggle-rotate" class="btn" type="button">Pause Auto‑Rotate</button>
        <button id="reset-view" class="btn" type="button">Reset View</button>
      </div>
    </div>

    <script>
      const mv = document.querySelector('model-viewer');
      const toggleBtn = document.getElementById('toggle-rotate');
      const resetBtn = document.getElementById('reset-view');
      const status = document.getElementById('status');
      const infoToggle = document.getElementById('info-toggle');
      const infoPanel = document.getElementById('info-panel');
      const infoClose = document.getElementById('info-close');
      const infoImage = document.getElementById('info-image');
      const infoImageFallback = document.getElementById('info-image-fallback');

      function setInfoOpen(open) {
        infoPanel.hidden = !open;
        infoToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
        infoToggle.textContent = open ? 'Hide Info' : 'Info';
      }

      infoToggle.addEventListener('click', () => {
        setInfoOpen(infoPanel.hidden);
      });
      infoClose.addEventListener('click', () => setInfoOpen(false));
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') setInfoOpen(false);
      });
      infoImage.addEventListener('error', () => {
        infoImage.hidden = true;
        infoImageFallback.hidden = false;
      });

      function setStatus(text) {
        status.style.display = '';
        status.textContent = text;
      }

      // If someone opened the file directly (file://), module scripts and fetches
      // often fail on mobile/desktop browsers. Always serve over http(s).
      if (window.location.protocol === 'file:') {
        setStatus('Open this page via http(s) (not file://). Start a server like: python3 -m http.server');
      }

      // Help debug cases where model-viewer fails to register (script blocked/offline/CSP).
      window.setTimeout(() => {
        if (!customElements.get('model-viewer')) {
          setStatus('model-viewer script failed to load (check network/CSP).');
        }
      }, 2000);

      // Proactively check that the GLB URL is reachable (common issue on GitHub Pages)
      // and surface the resolved URL + response headers.
      try {
        const modelUrl = new URL(mv.getAttribute('src'), window.location.href);
        setStatus(`Loading model…\n${modelUrl.href}`);

        const showResponseInfo = (r) => {
          // Some hosts omit Content-Length; still useful when present.
          const ct = r.headers.get('content-type') || 'unknown content-type';
          const cl = r.headers.get('content-length');
          const extra = cl ? ` (${cl} bytes)` : '';
          setStatus(`Loading model…\n${modelUrl.href}\n${ct}${extra}`);
        };

        fetch(modelUrl, { method: 'HEAD', cache: 'no-store' })
          .then((r) => {
            if (!r.ok) {
              setStatus(`Model file not reachable: ${r.status} ${r.statusText}`);
              return;
            }

            showResponseInfo(r);
          })
          .catch(() => {
            // Some servers don’t allow HEAD; fall back to GET to confirm reachability.
            fetch(modelUrl, { method: 'GET', cache: 'no-store' })
              .then((r) => {
                if (!r.ok) {
                  setStatus(`Model file not reachable: ${r.status} ${r.statusText}`);
                  return;
                }
                showResponseInfo(r);
              })
              .catch(() => {
                // Ignore: file:// cases or fetch blocked.
              });
          });
      } catch {
        // Ignore URL parsing errors.
      }

      function updateToggleLabel() {
        const isAuto = mv.hasAttribute('auto-rotate');
        toggleBtn.textContent = isAuto ? 'Pause Auto‑Rotate' : 'Resume Auto‑Rotate';
      }

      toggleBtn.addEventListener('click', () => {
        if (mv.hasAttribute('auto-rotate')) {
          mv.removeAttribute('auto-rotate');
        } else {
          mv.setAttribute('auto-rotate', '');
        }
        updateToggleLabel();
      });

      resetBtn.addEventListener('click', () => {
        // Reset camera orbit & field-of-view to defaults
        mv.cameraOrbit = '';
        mv.fieldOfView = '';
        // Briefly enable auto-rotate to settle, then revert to current state
        const hadAuto = mv.hasAttribute('auto-rotate');
        mv.setAttribute('auto-rotate', '');
        setTimeout(() => {
          if (!hadAuto) mv.removeAttribute('auto-rotate');
          updateToggleLabel();
        }, 500);
      });

      // Initialize labels to current state
      updateToggleLabel();

      // Model-Viewer load and error instrumentation
      mv.addEventListener('progress', (e) => {
        const p = Math.round((e?.detail?.totalProgress ?? 0) * 100);
        if (p > 0 && p < 100) setStatus(`Loading model… ${p}%`);
      });
      mv.addEventListener('load', () => {
        setStatus('Model loaded');
        setTimeout(() => { status.style.display = 'none'; }, 1200);
      });
      mv.addEventListener('error', (e) => {
        const msg = (e?.detail && e.detail.message) ? e.detail.message : 'Failed to load model';
        setStatus(`Error: ${msg}`);
        console.error('[model-viewer] error:', e);
      });
      // Basic capability check
      if (!('WebGLRenderingContext' in window)) {
        setStatus('WebGL not supported on this device/browser');
      }
    </script>
  </body>
</html>